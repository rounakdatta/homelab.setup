---
# Homelab infrastructure and secrets management playbook
#
# Usage:
#   Full setup:     ansible-playbook ansible/playbook.yml
#   Secrets only:   ansible-playbook ansible/playbook.yml --tags secrets
#   Infra only:     ansible-playbook ansible/playbook.yml --tags infra
#
# Bootstrap (one-time manual steps on new VM):
#   1. SSH into new VM via console or temporary key
#   2. curl -fsSL https://tailscale.com/install.sh | sh
#   3. sudo tailscale up --ssh   (enables Tailscale SSH for keyless access)
#   4. Now run: ansible-playbook ansible/playbook.yml --tags infra

- name: Setup homelab infrastructure
  hosts: homelab
  become: yes
  vars_files:
    - ../config.yml

  pre_tasks:
    - name: Verify Tailscale is installed and running
      ansible.builtin.command: tailscale status
      register: tailscale_check
      changed_when: false
      failed_when: false

    - name: Fail if Tailscale is not running
      ansible.builtin.fail:
        msg: "Tailscale is not running. Run: curl -fsSL https://tailscale.com/install.sh | sh && sudo tailscale up --ssh"
      when: tailscale_check.rc != 0

    - name: Ensure Tailscale SSH is enabled
      ansible.builtin.command: tailscale up --ssh --accept-risk=lose-ssh
      register: tailscale_ssh
      changed_when: "'Success' in tailscale_ssh.stdout or tailscale_ssh.rc == 0"
      failed_when: false

    - name: Get Tailscale IP address
      ansible.builtin.command: tailscale ip -4
      register: tailscale_ip
      changed_when: false

    - name: Set Tailscale IP as fact
      ansible.builtin.set_fact:
        host_tailscale_ip: "{{ tailscale_ip.stdout }}"

    - name: Display Tailscale IP
      ansible.builtin.debug:
        msg: "Using Tailscale IP: {{ host_tailscale_ip }}"

  roles:
    # Install and configure K3s with Tailscale binding
    - role: k3s
      tags: [k3s, infra]

    # Setup kubectl access and External Secrets Operator
    - role: k8s-setup
      tags: [k8s, infra]

# Secrets management play
# Runs on localhost to sync Bitwarden secrets to Kubernetes
- name: Sync secrets from Bitwarden to Kubernetes
  hosts: localhost
  connection: local
  gather_facts: no
  tags: [secrets]

  vars:
    # Secret definitions - add new services here
    k8s_secrets:
      # MySQL credentials (consolidated)
      - name: mysql-credentials
        namespace: databases
        data:
          root-password: mysql/root_password

      # PostgreSQL credentials (consolidated)
      - name: postgres-credentials
        namespace: databases
        data:
          root-password: postgres/root_password

      # Firefly III credentials (consolidated)
      - name: firefly-credentials
        namespace: apps
        data:
          app-key: firefly/app_key
          db-name: firefly/db_name
          db-username: firefly/db_username
          db-password: firefly/db_password

      # Memoet credentials (consolidated)
      - name: memoet-credentials
        namespace: apps
        data:
          db-name: memoet/db_name
          db-username: memoet/db_username
          db-password: memoet/db_password
          secret-key-base: memoet/secret_key_base

      # Snibox credentials (consolidated)
      - name: snibox-credentials
        namespace: apps
        data:
          secret-key-base: snibox/secret_key_base

      # Bookstack credentials (consolidated)
      - name: bookstack-credentials
        namespace: apps
        data:
          db-name: bookstack/db_name
          db-username: bookstack/db_username
          db-password: bookstack/db_password
          app-key: bookstack/app_key

      # Vikunja credentials (consolidated)
      - name: vikunja-credentials
        namespace: apps
        data:
          db-name: vikunja/db_name
          db-username: vikunja/db_username
          db-password: vikunja/db_password
          jwt-secret: vikunja/jwt_secret
          mailer-host: vikunja/mailer_host
          mailer-port: vikunja/mailer_port
          mailer-username: vikunja/mailer_username
          mailer-password: vikunja/mailer_password
          mailer-sender: vikunja/mailer_sender

      # Webtrees credentials (consolidated)
      - name: webtrees-credentials
        namespace: apps
        data:
          db-name: webtrees/db_name
          db-username: webtrees/db_username
          db-password: webtrees/db_password

      # Nextcloud credentials (consolidated)
      - name: nextcloud-credentials
        namespace: apps
        data:
          db-name: nextcloud/db_name
          db-username: nextcloud/db_username
          db-password: nextcloud/db_password

      # Authelia credentials
      - name: authelia-secrets
        namespace: authelia
        data:
          SESSION_SECRET: authelia/session_secret
          STORAGE_ENCRYPTION_KEY: authelia/storage_encryption_key
          SMTP_PASSWORD: authelia/smtp_password

      # Velero credentials are handled separately (uses secure notes)
      # See the "Create Velero credentials" task below

  pre_tasks:
    - name: Verify required environment variables
      ansible.builtin.fail:
        msg: "Required environment variable {{ item }} is not set"
      when: lookup('env', item) == ''
      loop:
        - BW_CLIENTID
        - BW_CLIENTSECRET
        - BW_PASSWORD

    - name: Verify Bitwarden CLI is installed
      ansible.builtin.command: bw --version
      register: bw_check
      changed_when: false

    - name: Unlock Bitwarden vault
      ansible.builtin.shell: |
        export BW_CLIENTID="{{ lookup('env', 'BW_CLIENTID') }}"
        export BW_CLIENTSECRET="{{ lookup('env', 'BW_CLIENTSECRET') }}"
        export BW_PASSWORD="{{ lookup('env', 'BW_PASSWORD') }}"
        bw login --apikey --raw || bw unlock --passwordenv BW_PASSWORD --raw
      register: bw_session
      changed_when: false
      no_log: true

    - name: Set Bitwarden session fact
      ansible.builtin.set_fact:
        BW_SESSION: "{{ bw_session.stdout }}"
      no_log: true

    - name: Ensure required namespaces exist
      ansible.builtin.shell: kubectl create namespace {{ item }} --dry-run=client -o yaml | kubectl apply -f -
      loop:
        - databases
        - apps
        - authelia
        - velero
      register: ns_result
      changed_when: "'created' in ns_result.stdout"
      failed_when: false

  tasks:
    - name: Create/Update K8s secrets from Bitwarden
      ansible.builtin.shell: |
        export BW_SESSION="{{ BW_SESSION }}"
        kubectl create secret generic {{ item.name }} \
          --namespace={{ item.namespace }} \
          {% for key, bw_path in item.data.items() %}
          --from-literal={{ key }}="$(bw get password '{{ bw_path }}' --session "$BW_SESSION")" \
          {% endfor %}
          --dry-run=client -o yaml | kubectl apply -f -
      loop: "{{ k8s_secrets }}"
      register: secret_result
      changed_when: "'configured' in secret_result.stdout or 'created' in secret_result.stdout"
      no_log: true

    - name: Create/Update Authelia users database from Bitwarden
      ansible.builtin.shell: |
        export BW_SESSION="{{ BW_SESSION }}"
        kubectl create secret generic authelia-users \
          --namespace=authelia \
          --from-literal=users_database.yml="$(bw get notes 'authelia/users_database' --session "$BW_SESSION")" \
          --dry-run=client -o yaml | kubectl apply -f -
      register: authelia_users_result
      changed_when: "'configured' in authelia_users_result.stdout or 'created' in authelia_users_result.stdout"
      no_log: true

    - name: Create/Update Velero credentials from Bitwarden
      ansible.builtin.shell: |
        export BW_SESSION="{{ BW_SESSION }}"
        kubectl create secret generic velero-credentials \
          --namespace=velero \
          --from-literal=cloud="$(bw get notes 'velero/r2_credentials_file' --session "$BW_SESSION")" \
          --dry-run=client -o yaml | kubectl apply -f -
      register: velero_creds_result
      changed_when: "'configured' in velero_creds_result.stdout or 'created' in velero_creds_result.stdout"
      no_log: true

    - name: Create/Update Velero BackupStorageLocation from Bitwarden
      ansible.builtin.shell: |
        export BW_SESSION="{{ BW_SESSION }}"
        R2_S3_URL="$(bw get password 'velero/r2_s3_url' --session "$BW_SESSION")"
        R2_BUCKET="$(bw get password 'velero/r2_bucket' --session "$BW_SESSION")"
        cat <<EOF | kubectl apply -f -
        apiVersion: velero.io/v1
        kind: BackupStorageLocation
        metadata:
          name: default
          namespace: velero
          labels:
            app.kubernetes.io/name: velero
        spec:
          credential:
            name: velero-credentials
            key: cloud
          provider: aws
          accessMode: ReadWrite
          default: true
          objectStorage:
            bucket: "${R2_BUCKET}"
            prefix: velero
          config:
            region: "auto"
            s3ForcePathStyle: "true"
            s3Url: "${R2_S3_URL}"
        EOF
      register: velero_bsl_result
      changed_when: "'configured' in velero_bsl_result.stdout or 'created' in velero_bsl_result.stdout"
      no_log: true

    - name: Display sync results
      ansible.builtin.debug:
        msg: "âœ“ Synced {{ k8s_secrets | length + 3 }} secrets/resources to Kubernetes (including authelia-users, velero-credentials, velero BSL)"
