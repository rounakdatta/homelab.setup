name: Deploy infrastructure

# Run manually when setting up a new machine
# Regular deployments use deploy-stuff.yml
#
# PREREQUISITE (one-time on new VM):
#   1. SSH into VM via console or temporary key
#   2. curl -fsSL https://tailscale.com/install.sh | sh
#   3. sudo tailscale up --ssh
#   4. Then run this workflow

on:
  workflow_dispatch:

jobs:
  setup:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Tailscale
        uses: tailscale/github-action@v2
        with:
          authkey: ${{ secrets.TAILSCALE_AUTHKEY }}
          version: 1.76.1
          args: --advertise-tags=tag:homelab

      - name: Configure Ansible for Tailscale SSH
        run: |
          # Create a wrapper script that translates SSH calls to tailscale ssh
          cat > /tmp/tailscale-ssh-wrapper << 'WRAPPER'
          #!/bin/bash
          # Wrapper to make tailscale ssh work with Ansible
          # Ansible calls: ssh [options] user@host command
          # We need: tailscale ssh user@host command

          # Parse arguments, skipping SSH options that tailscale ssh doesn't understand
          host=""
          cmd=""
          skip_next=false

          for arg in "$@"; do
            if $skip_next; then
              skip_next=false
              continue
            fi

            case "$arg" in
              -o|-i|-F|-p|-l|-L|-R|-D|-W|-S|-E|-J|-B) skip_next=true ;;
              -o*|-i*|-F*|-p*|-l*) ;; # Skip combined options
              -[CvqTtNfngAKXYG]*) ;; # Skip single-letter options
              -*)  ;; # Skip any other options
              *)
                if [[ -z "$host" ]]; then
                  host="$arg"
                else
                  cmd="$arg"
                fi
                ;;
            esac
          done

          if [[ -n "$cmd" ]]; then
            exec tailscale ssh "$host" "$cmd"
          else
            exec tailscale ssh "$host"
          fi
          WRAPPER
          chmod +x /tmp/tailscale-ssh-wrapper

          # Configure Ansible to use the wrapper
          cat > ~/.ansible.cfg << 'EOF'
          [defaults]
          host_key_checking = False
          remote_tmp = /tmp/.ansible/tmp

          [ssh_connection]
          ssh_executable = /tmp/tailscale-ssh-wrapper
          transfer_method = piped
          pipelining = True
          EOF

      - name: Install Ansible
        run: |
          pip install ansible
          ansible-galaxy collection install -r ansible/requirements.yml

      - name: Run Ansible infrastructure setup
        env:
          MACHINE_NAME: ${{ secrets.MACHINE_NAME }}
        run: |
          # Create temporary inventory with Tailscale hostname
          echo "[homelab]" > /tmp/inventory
          echo "${MACHINE_NAME} ansible_user=root" >> /tmp/inventory

          ANSIBLE_CONFIG=~/.ansible.cfg ansible-playbook ansible/playbook.yml -i /tmp/inventory --tags infra -v

      - name: Verify infrastructure
        env:
          MACHINE_NAME: ${{ secrets.MACHINE_NAME }}
        run: |
          mkdir -p ~/.kube
          tailscale ssh root@${MACHINE_NAME} "cat /etc/rancher/k3s/k3s.yaml" > ~/.kube/config
          sed -i "s|https://127.0.0.1:6443|https://${MACHINE_NAME}:6443|g" ~/.kube/config

          kubectl get nodes
          kubectl get pods -A
