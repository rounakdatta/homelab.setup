name: Setup Infrastructure

# Run manually when setting up a new machine
# Regular deployments use deploy-k8s.yml
#
# PREREQUISITE (one-time on new VM):
#   1. SSH into VM via console or temporary key
#   2. curl -fsSL https://tailscale.com/install.sh | sh
#   3. sudo tailscale up --ssh
#   4. Then run this workflow

on:
  workflow_dispatch:

jobs:
  setup:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Tailscale
        uses: tailscale/github-action@v2
        with:
          authkey: ${{ secrets.TAILSCALE_AUTHKEY }}
          version: 1.76.1

      - name: Configure Ansible for Tailscale SSH
        run: |
          # Tell Ansible to use tailscale ssh
          mkdir -p ~/.ansible
          cat > ~/.ansible/ansible.cfg << 'EOF'
          [defaults]
          host_key_checking = False

          [ssh_connection]
          ssh_executable = /usr/bin/tailscale
          ssh_args = ssh
          EOF

      - name: Install Ansible
        run: |
          pip install ansible
          ansible-galaxy collection install -r ansible/requirements.yml

      - name: Run Ansible infrastructure setup
        env:
          MACHINE_NAME: ${{ secrets.MACHINE_NAME }}
        run: |
          # Create temporary inventory with Tailscale hostname
          echo "[homelab]" > /tmp/inventory
          echo "${MACHINE_NAME} ansible_user=root ansible_ssh_executable='tailscale' ansible_ssh_common_args='ssh'" >> /tmp/inventory

          ansible-playbook ansible/playbook.yml -i /tmp/inventory --tags infra -v

      - name: Verify infrastructure
        env:
          MACHINE_NAME: ${{ secrets.MACHINE_NAME }}
        run: |
          mkdir -p ~/.kube
          tailscale ssh root@${MACHINE_NAME} "cat /etc/rancher/k3s/k3s.yaml" > ~/.kube/config
          sed -i "s|https://127.0.0.1:6443|https://${MACHINE_NAME}:6443|g" ~/.kube/config

          kubectl get nodes
          kubectl get pods -A
