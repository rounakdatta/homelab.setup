name: Deploy to K8s

on:
  push:
    branches: [main]
    paths:
      - 'kubernetes/**'
      - 'ansible/**'
      - '.github/workflows/deploy-k8s.yml'
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Tailscale
        uses: tailscale/github-action@v2
        with:
          authkey: ${{ secrets.TAILSCALE_AUTHKEY }}
          version: 1.76.1
          args: --advertise-tags=tag:homelab

      - name: Fetch kubeconfig via Tailscale SSH
        run: |
          # Tailscale SSH - no keys needed!
          mkdir -p ~/.kube
          tailscale ssh root@${{ secrets.MACHINE_NAME }} "cat /etc/rancher/k3s/k3s.yaml" > ~/.kube/config
          sed -i "s|https://127.0.0.1:6443|https://${{ secrets.MACHINE_NAME }}:6443|g" ~/.kube/config
          kubectl cluster-info

      - name: Sync secrets from Bitwarden
        env:
          BW_CLIENTID: ${{ secrets.BW_CLIENTID }}
          BW_CLIENTSECRET: ${{ secrets.BW_CLIENTSECRET }}
          BW_PASSWORD: ${{ secrets.BW_PASSWORD }}
        run: |
          npm install -g @bitwarden/cli
          pip install ansible
          ansible-galaxy collection install -r ansible/requirements.yml
          ansible-playbook ansible/playbook.yml --tags secrets -i localhost,

      - name: Install Velero CRDs
        run: |
          # Install Velero CRDs before applying manifests
          # CRDs need to exist before custom resources can be created
          kubectl apply -f https://raw.githubusercontent.com/vmware-tanzu/velero/v1.17.1/config/crd/v1/bases/velero.io_backups.yaml
          kubectl apply -f https://raw.githubusercontent.com/vmware-tanzu/velero/v1.17.1/config/crd/v1/bases/velero.io_backupstoragelocations.yaml
          kubectl apply -f https://raw.githubusercontent.com/vmware-tanzu/velero/v1.17.1/config/crd/v1/bases/velero.io_deletebackuprequests.yaml
          kubectl apply -f https://raw.githubusercontent.com/vmware-tanzu/velero/v1.17.1/config/crd/v1/bases/velero.io_downloadrequests.yaml
          kubectl apply -f https://raw.githubusercontent.com/vmware-tanzu/velero/v1.17.1/config/crd/v1/bases/velero.io_podvolumebackups.yaml
          kubectl apply -f https://raw.githubusercontent.com/vmware-tanzu/velero/v1.17.1/config/crd/v1/bases/velero.io_podvolumerestores.yaml
          kubectl apply -f https://raw.githubusercontent.com/vmware-tanzu/velero/v1.17.1/config/crd/v1/bases/velero.io_restores.yaml
          kubectl apply -f https://raw.githubusercontent.com/vmware-tanzu/velero/v1.17.1/config/crd/v1/bases/velero.io_schedules.yaml
          kubectl apply -f https://raw.githubusercontent.com/vmware-tanzu/velero/v1.17.1/config/crd/v1/bases/velero.io_serverstatusrequests.yaml
          kubectl apply -f https://raw.githubusercontent.com/vmware-tanzu/velero/v1.17.1/config/crd/v1/bases/velero.io_volumesnapshotlocations.yaml
          kubectl apply -f https://raw.githubusercontent.com/vmware-tanzu/velero/v1.17.1/config/crd/v1/bases/velero.io_datadownloads.yaml
          kubectl apply -f https://raw.githubusercontent.com/vmware-tanzu/velero/v1.17.1/config/crd/v1/bases/velero.io_datauploads.yaml
          kubectl apply -f https://raw.githubusercontent.com/vmware-tanzu/velero/v1.17.1/config/crd/v1/bases/velero.io_backuprepositories.yaml

      - name: Deploy manifests
        run: |
          kubectl apply -k kubernetes/
          echo ""
          echo "=== Deployment Status ==="
          kubectl get pods -A | grep -v kube-system
