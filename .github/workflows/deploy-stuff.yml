name: Deploy stuff to the infrastructure

on:
  push:
    branches: [main]
    paths:
      - 'kubernetes/**'
      - 'ansible/**'
      - '.github/workflows/deploy-stuff.yml'
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Tailscale
        uses: tailscale/github-action@v2
        with:
          authkey: ${{ secrets.TAILSCALE_AUTHKEY }}
          version: 1.76.1
          args: --advertise-tags=tag:homelab

      - name: Fetch kubeconfig via Tailscale SSH
        run: |
          # Tailscale SSH - no keys needed!
          mkdir -p ~/.kube
          tailscale ssh root@${{ secrets.MACHINE_NAME }} "cat /etc/rancher/k3s/k3s.yaml" > ~/.kube/config
          sed -i "s|https://127.0.0.1:6443|https://${{ secrets.MACHINE_NAME }}:6443|g" ~/.kube/config
          kubectl cluster-info

      - name: Install Bitwarden CLI
        run: npm install -g @bitwarden/cli

      - name: Sync secrets from Bitwarden
        env:
          BW_CLIENTID: ${{ secrets.BW_CLIENTID }}
          BW_CLIENTSECRET: ${{ secrets.BW_CLIENTSECRET }}
          BW_PASSWORD: ${{ secrets.BW_PASSWORD }}
        run: |
          pip install ansible
          ansible-galaxy collection install -r ansible/requirements.yml
          ansible-playbook ansible/playbook.yml --tags secrets -i localhost,

      - name: Deploy manifests
        run: |
          kubectl apply -k kubernetes/
          echo ""
          echo "=== Deployment Status ==="
          kubectl get pods -A | grep -v kube-system

      - name: Configure Velero BackupStorageLocation
        env:
          BW_CLIENTID: ${{ secrets.BW_CLIENTID }}
          BW_CLIENTSECRET: ${{ secrets.BW_CLIENTSECRET }}
          BW_PASSWORD: ${{ secrets.BW_PASSWORD }}
        run: |
          set -e

          # Wait for Velero CRDs to be ready
          echo "Waiting for Velero CRDs..."
          kubectl wait --for=condition=established crd/backupstoragelocations.velero.io --timeout=60s

          # Login to Bitwarden and get values
          echo "Fetching Velero config from Bitwarden..."
          bw logout 2>/dev/null || true
          export BW_SESSION=$(bw login --apikey --raw)

          export R2_S3_URL=$(bw get password 'velero/r2_s3_url' --session "$BW_SESSION")
          export R2_BUCKET=$(bw get password 'velero/r2_bucket' --session "$BW_SESSION")

          # Validate values
          if [ -z "$R2_S3_URL" ] || [ -z "$R2_BUCKET" ]; then
            echo "ERROR: Failed to retrieve Velero config from Bitwarden"
            echo "  R2_S3_URL empty: $([ -z "$R2_S3_URL" ] && echo 'yes' || echo 'no')"
            echo "  R2_BUCKET empty: $([ -z "$R2_BUCKET" ] && echo 'yes' || echo 'no')"
            exit 1
          fi

          # Create BackupStorageLocation
          echo "Creating Velero BackupStorageLocation..."
          cat > /tmp/velero-bsl.yaml <<'BSLEOF'
          apiVersion: velero.io/v1
          kind: BackupStorageLocation
          metadata:
            name: default
            namespace: velero
            labels:
              app.kubernetes.io/name: velero
          spec:
            credential:
              name: velero-credentials
              key: cloud
            provider: aws
            accessMode: ReadWrite
            default: true
            objectStorage:
              bucket: "${R2_BUCKET}"
              prefix: velero
            config:
              region: auto
              s3ForcePathStyle: "true"
              s3Url: "${R2_S3_URL}"
          BSLEOF
          # Substitute env vars and remove leading whitespace
          envsubst < /tmp/velero-bsl.yaml | sed 's/^          //' | kubectl apply -f -
          rm /tmp/velero-bsl.yaml
          echo "âœ“ Velero BackupStorageLocation configured"
